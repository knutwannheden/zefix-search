{% extends 'base.html' %}

{% block content %}
    <h1>{% block title %} Zefix Search {% endblock %}</h1>
    <link rel="stylesheet" href="/path/to/styles/default.min.css">
    <script src="/path/to/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>
        // Get the input field
        var input = document.getElementById("search");

        // Execute a function when the user presses a key on the keyboard
        input.addEventListener("keypress", function (event) {
            // If the user presses the "Enter" key on the keyboard
            if (event.key === "Enter") {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                document.getElementById("submit").click();
            }
        });

        function unescape_entities(text) {
            text = text.replace("&amp;amp;quot", "\"")
            text = text.replace("&amp;amp;", "&")
            text = text.replace("&amp;lt;", "<")
            text = text.replace("&amp;gt;", ">")
            text = text.replace("&amp;apos;", "'")
            text = text.replace("&amp;quot;", "\"")
            text = text.replace("&amp;", "&")
            text = text.replace("&lt;", "<")
            text = text.replace("&gt;", ">")
            text = text.replace("&apos;", "'")
            text = text.replace("&quot;", "\"")
            return text
        }

        async function userAction() {
            const response = await fetch('https://votewatch.ch/search?q='
                                         + encodeURIComponent(document.getElementById('search').value));
            const myJson = await response.json(); //extract JSON from the http response
            const table = document.getElementById('result')
            for (var i = 0; i < myJson.length; i++) {
                tr = table.insertRow(-1);
                var tabCell = tr.insertCell(-1);
                tabCell.textContent = myJson[i].sogcPublication.sogcId;
                tabCell = tr.insertCell(-1);
                tabCell.textContent = myJson[i].sogcPublication.sogcDate;
                tabCell = tr.insertCell(-1);
                tabCell.textContent = myJson[i].companyShort.name;
                tabCell = tr.insertCell(-1);
                tabCell.textContent = unescape_entities(myJson[i].sogcPublication.message.replace(/<FT TYPE=".">([^<]+)<\/FT>/g, '$1'));
            }
            // {#document.getElementById('result').textContent = JSON.stringify(myJson);#}
            // document.getElementById('result').innerHTML = hljs.highlight(JSON.stringify(myJson), {language: 'json'}).value
            // console.log(myJson);
        }
    </script>

    <input id="search" type="text" name="title"
           placeholder="Search string"
           value="{{ request.form['title'] }}"></input>
    <button id="submit" type="submit" onclick="userAction()">Search</button>
    <br>
    <label>Result</label>
    <table id="result">
        <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Company</th>
            <th>Text</th>
        </tr>
    </table>
    <!--/form-->
{% endblock %}
