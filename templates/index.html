{% extends 'base.html' %}

{% block content %}
    <style>
        #myProgress {
            width: 100%;
            background-color: #ddd;
        }

        #myBar {
            width: 0%;
            height: 30px;
            background-color: #04AA6D;
        }
    </style>

    <h1>{% block title %} Zefix Search {% endblock %}</h1>

    <label for="search"></label>
    <input id="search" type="text" name="title"
           placeholder="Search string"
           value="{{ request.form['title'] }}">
    <button id="submit" type="submit" onclick="userAction()">Search</button>
    <script>
        // Get the input field
        const input = document.getElementById("search");

        // Execute a function when the user presses a key on the keyboard
        input.addEventListener("keyup", function (event) {
            // If the user presses the "Enter" key on the keyboard
            if (event.key === "Enter") {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                document.getElementById("submit").click();
            }
        });

        function scrub_message(text) {
            text = text.replace(/&amp;amp;quot/g, "\"")
            text = text.replace(/&amp;amp;/g, "&")
            text = text.replace(/&amp;lt;/, "<")
            text = text.replace(/&amp;gt;/g, ">")
            text = text.replace(/amp;apos;/g, "'")
            text = text.replace(/&amp;quot;/g, "\"")
            text = text.replace(/&amp;/g, "&")
            text = text.replace(/&lt;/g, "<")
            text = text.replace(/&gt;/g, ">")
            text = text.replace(/&apos;/g, "'")
            text = text.replace(/&quot;/g, "\"")
            text = text.replace(/<[A-Z]>([^<]+)<E>/g, '$1')
            text = text.replace(/<FT TYPE=".">([^<]+)<\/FT>/g, '$1')
            return text
        }

        var i = 0;
        var width = 0;
        var done = false;
        function move() {
            if (i == 0) {
                i = 1;
                var elem = document.getElementById("myBar");
                var id = setInterval(frame, 50);
                function frame() {
                    if (done) {
                        elem.style.width = "100%";
                        clearInterval(id);
                        i = 0;
                        width = 100;
                    } else {
                        width = (width + 1) % 100;
                        elem.style.width = width + "%";
                    }
                }
            }
        }

        async function* makeTextFileLineIterator(fileURL) {
            const utf8Decoder = new TextDecoder("utf-8");
            let response = await fetch(fileURL);
            let reader = response.body.getReader();
            let {
                value: chunk,
                done: readerDone
            } = await reader.read();
            chunk = chunk ? utf8Decoder.decode(chunk, { stream: true }) : "";

            let re = /\n+/gm;
            let startIndex = 0;

            for (; ;) {
                let result = re.exec(chunk);
                if (!result) {
                    if (readerDone) {
                        break;
                    }
                    let remainder = chunk.substring(startIndex);
                    ({
                        value: chunk,
                        done: readerDone
                    } = await reader.read());
                    chunk = remainder + (chunk ? utf8Decoder.decode(chunk, { stream: true }) : "");
                    startIndex = re.lastIndex = 0;
                    continue;
                }
                yield chunk.substring(startIndex, result.index);
                startIndex = re.lastIndex;
            }
            if (startIndex < chunk.length) {
                // last line didn't end in a newline char
                yield chunk.substring(startIndex);
            }
        }

        async function userAction() {
            const table = document.getElementById('result')
            const body = table.getElementsByTagName('tbody')[0]
            body.innerHTML = ''

            i = 0; width = 0; done = false;
            move();

            for await (let line of
                makeTextFileLineIterator('search?q=' + encodeURIComponent(document.getElementById('search').value)))
            {
                try {
                    let myJson = JSON.parse(line)

                    let tr = body.insertRow(-1);
                    let tabCell = tr.insertCell(-1);
                    tabCell.innerHTML =
                        `<a href="${'https://www.zefix.ch/en/search/entity/list/firm/' + myJson.companyShort.ehraid + '#shabPub-'
                                    + myJson.sogcPublication.sogcId}">${myJson.sogcPublication.sogcId}</a>`;
                    tabCell = tr.insertCell(-1);
                    tabCell.textContent = myJson.sogcPublication.sogcDate;
                    tabCell = tr.insertCell(-1);
                    tabCell.innerHTML =
                        `<a href="${'https://www.zefix.ch/en/search/entity/list/firm/'
                                    + myJson.companyShort.ehraid}">${myJson.companyShort.name}</a>`;
                    tabCell = tr.insertCell(-1);
                    tabCell.textContent = scrub_message(myJson.sogcPublication.message);
                } catch (e) {
                    console.log(e, line)
                }
                i = 0; width = 100; done = true;
            }
        }
    </script>
    <div id="myProgress">
        <div id="myBar"></div>
    </div>
    <br>
    <label>Result</label>
    <table id="result">
        <thead>
        <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Company</th>
            <th>Text</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
{% endblock %}
